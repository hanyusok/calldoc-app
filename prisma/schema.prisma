generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String                   @id @default(cuid())
  name                    String?
  email                   String                   @unique
  password                String?
  role                    Role                     @default(PATIENT)
  emailVerified           DateTime?
  image                   String?
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  age                     Int?
  gender                  String?
  phoneNumber             String?
  residentNumber          String?
  pharmacyId              String?
  accounts                Account[]
  appointments            Appointment[]
  familyMembers           FamilyMember[]
  insurance               Insurance?
  notifications           Notification[]
  sessions                Session[]
  pharmacy                Pharmacy?                @relation("UserPharmacy", fields: [pharmacyId], references: [id])
  favoritePharmacies      UserFavoritePharmacy[]
  vaccinationReservations VaccinationReservation[]
}

model Insurance {
  id           String @id @default(cuid())
  provider     String
  policyNumber String
  userId       String @unique
  user         User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model FamilyMember {
  id             String        @id @default(cuid())
  name           String
  relation       String
  age            Int
  gender         String
  residentNumber String?
  phoneNumber    String?
  userId         String
  appointments   Appointment[]
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

model Doctor {
  id              String            @id @default(cuid())
  name            String
  specialty       String
  clinicId        String?
  rating          Float             @default(5.0)
  patients        Int               @default(0)
  imageUrl        String?
  bio             String?
  gender          String?
  address         String?
  consultationFee Int               @default(5000)
  isAvailable     Boolean           @default(true)
  appointments    Appointment[]
  clinic          Clinic?           @relation(fields: [clinicId], references: [id])
  exceptions      DoctorException[]
  schedules       DoctorSchedule[]
}

model Clinic {
  id          String   @id @default(cuid())
  name        String
  description String?
  address     String
  city        String?
  latitude    Float?
  longitude   Float?
  phoneNumber String?
  website     String?
  rating      Float    @default(0.0)
  images      String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  isVisible   Boolean  @default(true)
  doctors     Doctor[]
}

model DoctorSchedule {
  id             String   @id @default(cuid())
  doctorId       String
  dayOfWeek      Int
  startTime      String
  endTime        String
  slotDuration   Int      @default(30)
  breakStartTime String?
  breakEndTime   String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  doctor         Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@unique([doctorId, dayOfWeek])
}

model DoctorException {
  id          String   @id @default(cuid())
  doctorId    String
  date        DateTime @db.Date
  isAvailable Boolean  @default(false)
  startTime   String?
  endTime     String?
  reason      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  doctor      Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@unique([doctorId, date])
}

model Appointment {
  id             String            @id @default(cuid())
  userId         String
  doctorId       String
  familyMemberId String?
  date           DateTime
  price          Float?
  meetingLink    String?
  symptoms       String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @default(now()) @updatedAt
  status         AppointmentStatus @default(PENDING)
  doctor         Doctor            @relation(fields: [doctorId], references: [id])
  familyMember   FamilyMember?     @relation(fields: [familyMemberId], references: [id])
  user           User              @relation(fields: [userId], references: [id])
  payment        Payment?
  prescription   Prescription?
}

model Payment {
  id             String      @id @default(cuid())
  paymentKey     String?     @unique
  amount         Int
  method         String?
  status         String      @default("PENDING")
  requestedAt    DateTime    @default(now())
  approvedAt     DateTime?
  receiptUrl     String?
  appointmentId  String      @unique
  authNo         String?
  refundedAmount Int         @default(0)
  appointment    Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
}

model Pharmacy {
  id        String   @id @default(cuid())
  name      String
  fax         String?
  faxLocked   Boolean  @default(false)
  faxVerified Boolean  @default(false)
  phone       String?
  address     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  isDefault Boolean  @default(false)
  latitude  Float    @default(0.0)
  longitude Float    @default(0.0)
  atFront   Boolean  @default(false)
  users     User[]   @relation("UserPharmacy")
  favoritedBy UserFavoritePharmacy[]
}

model UserFavoritePharmacy {
  userId     String
  pharmacyId String
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  pharmacy   Pharmacy @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)

  @@id([userId, pharmacyId])
}

model Prescription {
  id              String             @id @default(cuid())
  appointmentId   String             @unique
  pharmacyName    String
  pharmacyFax     String?
  pharmacyPhone   String?
  pharmacyAddress String?
  status          PrescriptionStatus @default(PENDING)
  fileUrl         String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  appointment     Appointment        @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
}

model AppSettings {
  id                 Int     @id @default(1)
  siteName           String  @default("CallDoc")
  maintenanceMode    Boolean @default(false)
  homePostsCount     Int     @default(3)
  heroBannerTitle    String  @default("지금 바로 진료 예약")
  heroBannerSubtitle String  @default("전문의와 비대면으로 빠르고 편리하게")
  prescriptionPdfPath String @default("C:\\Mts3\\PDF")
}

model Post {
  id        String   @id @default(cuid())
  title     String
  content   String
  imageUrl  String?
  author    String?
  category  String?  @default("Health")
  published Boolean  @default(true)
  locale    String   @default("ko")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Vaccination {
  id              String                   @id @default(cuid())
  name            String                   @unique
  nameEn          String?
  price           Float
  description     String?
  descriptionEn   String?
  visitTime       String?
  visitTimeEn     String?
  location        String?
  locationEn      String?
  category        String?
  categoryEn      String?
  manufacturer    String?
  manufacturerEn  String?
  targetDisease   String?
  targetDiseaseEn String?
  minAge          Int?
  maxAge          Int?
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt
  reservations    VaccinationReservation[]
}

model VaccinationReservation {
  id            String      @id @default(cuid())
  userId        String
  vaccinationId String
  date          DateTime?
  status        String      @default("PENDING")
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  user          User        @relation(fields: [userId], references: [id])
  vaccination   Vaccination @relation(fields: [vaccinationId], references: [id])
}

model MeetPreset {
  id          String   @id @default(cuid())
  name        String
  link        String
  description String?
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  message   String
  key       String?
  params    String?
  isRead    Boolean  @default(false)
  link      String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum Role {
  PATIENT
  ADMIN
  STAFF
  PHARMACIST
}

enum AppointmentStatus {
  PENDING
  AWAITING_PAYMENT
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum PrescriptionStatus {
  PENDING
  REQUESTED
  ISSUED
  REJECTED
}
